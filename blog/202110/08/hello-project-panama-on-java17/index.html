<!DOCTYPE html>
<html><head lang="ja">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Hello Project Panama, on Java17 - 発火後忘失</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
はじめに




Hello Project Panama – 発火後忘失




で、 Project Panama (リンク1, リンク2) の機能を利用して、 Java から Rust を呼び出してみました。


当時(Java14)は Project Panama 用にビルドされた JDK を利用する必要がありましたが、 Java17 では incubator ではあるものの JEP 412: Foreign Function &amp; Memory API が標準 JDK に導入された
" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="https://yukihane.github.io/blog/202110/08/hello-project-panama-on-java17/">
  <meta property="og:site_name" content="発火後忘失">
  <meta property="og:title" content="Hello Project Panama, on Java17">
  <meta property="og:description" content="はじめに Hello Project Panama – 発火後忘失
で、 Project Panama (リンク1, リンク2) の機能を利用して、 Java から Rust を呼び出してみました。
当時(Java14)は Project Panama 用にビルドされた JDK を利用する必要がありましたが、 Java17 では incubator ではあるものの JEP 412: Foreign Function &amp; Memory API が標準 JDK に導入された">
  <meta property="og:locale" content="ja">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2021-10-08T04:49:30+00:00">
    <meta property="article:modified_time" content="2021-10-08T04:49:30+00:00">
    <meta property="article:tag" content="Java">
    <meta property="article:tag" content="Rust">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Hello Project Panama, on Java17">
  <meta name="twitter:description" content="はじめに Hello Project Panama – 発火後忘失
で、 Project Panama (リンク1, リンク2) の機能を利用して、 Java から Rust を呼び出してみました。
当時(Java14)は Project Panama 用にビルドされた JDK を利用する必要がありましたが、 Java17 では incubator ではあるものの JEP 412: Foreign Function &amp; Memory API が標準 JDK に導入された">

        <link href="https://yukihane.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://yukihane.github.io/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://yukihane.github.io/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css"  disabled />
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://yukihane.github.io/">発火後忘失</a>
	</div>
	<nav>
		
		<a href="/blog">Blog</a>
		
		<a href="/docs">Docs</a>
		
		<a href="/tags">Tags</a>
		
		<a href="https://github.com/yukihane/resume/blob/main/README.md">Profile</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#sun" />
</svg></span>
		<script src="https://yukihane.github.io/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">Hello Project Panama, on Java17</h1>
          <div class="meta">Posted on 2021/10/08</div>
        </div>
        
        <section class="body">
          <div class="sect1">
<h2 id="_はじめに">はじめに</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://yukihane.github.io/blog/202002/11/hello-project-panama/">Hello Project Panama – 発火後忘失</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>で、 Project Panama (<a href="https://openjdk.java.net/projects/panama/">リンク1</a>, <a href="https://jdk.java.net/panama/">リンク2</a>) の機能を利用して、 Java から Rust を呼び出してみました。</p>
</div>
<div class="paragraph">
<p>当時(Java14)は Project Panama 用にビルドされた JDK を利用する必要がありましたが、 Java17 では incubator ではあるものの <a href="https://openjdk.java.net/jeps/412">JEP 412: Foreign Function &amp; Memory API</a> が標準 JDK に導入された</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://qiita.com/nowokay/items/ec58bf8f30d236a12acb">Java 17新機能まとめ - Qiita</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ので、標準の JDK でも冒頭にリンクしたコード相当のものをビルド、実行できるようになりました(※ 後述の通り <a href="https://github.com/openjdk/panama-foreign/blob/foreign-jextract/doc/panama_jextract.md"><code>jextract</code> コマンド</a> は標準 JDK に含まれていないので別途取得する必要があります)。</p>
</div>
<div class="paragraph">
<p>API, <code>jextract</code> コマンド引数など、 Java14 当時と結構変わっていましたので、改めて project Panama を使って Hello, world してみたいと思います。</p>
</div>
<div class="paragraph">
<p>今回の成果物は次のリンク先にあります:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/yukihane/hello-java/tree/master/project-panama/java17" class="bare">https://github.com/yukihane/hello-java/tree/master/project-panama/java17</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_環境">環境</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Ubuntu 20.04</p>
<div class="ulist">
<ul>
<li>
<p>後で Windows10 上でも試してみましたが、こちらも上手く動作しました</p>
</li>
</ul>
</div>
</li>
<li>
<p>Java Corretto-17.0.0.35.1</p>
</li>
<li>
<p><code>jextract</code> Build 17-panama+3-167 (2021/5/18)</p>
</li>
<li>
<p>rustc 1.55.0</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_作成手順">作成手順</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_rust_でダイナミックリンクライブラリ作成">Rust でダイナミックリンクライブラリ作成</h3>
<div class="paragraph">
<p><code>greeter</code> という名前でプロジェクトを作成します。
プロジェクトルートディレクトリで次のコマンドを実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">cargo new --lib greeter
cd greeter</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://crates.io/crates/libc"><code>libc</code> クレート</a>を依存関係に追加します。
また、ダイナミックリンクライブラリを生成するように <code>crate-type</code> に <code>cdylib</code> を設定します。</p>
</div>
<div class="listingblock">
<div class="title">Cargo.toml</div>
<div class="content">
<pre class="highlight"><code class="language-toml" data-lang="toml">[dependencies]
libc = &#34;0.2.103&#34;
[lib]
crate-type = [&#34;cdylib&#34;]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rust 側で行う処理を実装します。</p>
</div>
<div class="listingblock">
<div class="title">src/lib.rs</div>
<div class="content">
<pre class="highlight"><code class="language-rust" data-lang="rust">use libc::size_t;
use std::ffi::{CStr, CString};
use std::os::raw::c_char;

#[no_mangle]
pub unsafe extern &#34;C&#34; fn greet(name: *const c_char, message: *mut c_char, count: size_t) {
    let name = CStr::from_ptr(name);
    let name = name.to_str().unwrap();
    let text = format!(&#34;こんにちは、{}！&#34;, name);
    let text = CString::new(text).unwrap();

    message.copy_from(text.as_ptr(), count);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>ビルドします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">cargo build --release</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_参考">参考</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html#the-crate-type-field">The Cargo Book &gt; 3.2.1. Cargo Targets &gt; The crate-type field</a></p>
</li>
<li>
<p><a href="https://doc.rust-lang.org/nomicon/ffi.html#calling-rust-code-from-c">The Rustonomicon &gt; 11. Foreign Function Interface &gt; Calling Rust code from C</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ダイナミックリンクライブラリの_c_ヘッダ自動生成">ダイナミックリンクライブラリの C ヘッダ自動生成</h3>
<div class="paragraph">
<p>上で作成したライブラリのヘッダファイルを自動生成します。</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/eqrion/cbindgen"><code>cbindgen</code></a> コマンドをインストールします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">cargo install --force cbindgen</code></pre>
</div>
</div>
<div class="paragraph">
<p>プロジェクトルートディレクトリで次のコマンドを実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">cbindgen -l c -o bridges/greeter.h greeter</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記コマンド実行により <code>bridges/greeter.h</code> ヘッダファイルが生成されます。</p>
</div>
<div class="listingblock">
<div class="title">bridges/greeter.h</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">#include &lt;stdarg.h&gt;
#include &lt;stdbool.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdlib.h&gt;

void greet(const char *name, char *message, size_t count);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_c_ヘッダから_java_api_自動生成">C ヘッダから Java API 自動生成</h3>
<div class="paragraph">
<p><code>jextract</code> コマンドを利用してヘッダファイルから Java API を自動生成します。</p>
</div>
<div class="paragraph">
<p><code>jextract</code> コマンドは <a href="https://jdk.java.net/panama/">Project Panama の Early Access Build</a> をダウンロードし展開すると <code>bin</code> ディレクトリ下にあります。</p>
</div>
<div class="paragraph">
<p>プロジェクトルートディレクトリで次のコマンドを実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/path/to/jextract \
-l greeter \
-d classes \
-t com.example \
./bridges/greeter.h</pre>
</div>
</div>
<div class="paragraph">
<p>上記コマンドを実行すると <code>classes</code> ディレクトリ下にクラスファイルが生成されます。</p>
</div>
<div class="sect3">
<h4 id="_補足参考">補足/参考</h4>
<div class="ulist">
<ul>
<li>
<p>上で自動生成した <code>bridges/greeter.h</code> は、実際には不必要なインクルードを含んでいます。
これを削減し、 <code>#include &lt;stddef.h&gt;</code> (<code>size_t</code> を定義しているヘッダファイル) だけにすると、ここで自動生成されるファイルも減ります。</p>
</li>
<li>
<p><code>jextract</code> コマンドに <code>--source</code> オプションを付与すると、 <code>.class</code> ファイルでなく <code>.java</code> ファイルが生成されます。</p>
</li>
<li>
<p><code>jextract</code> コマンドの詳細は次のリンク先を参照:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/openjdk/panama-foreign/blob/foreign-jextract/doc/panama_jextract.md">Using the jextract tool - openjdk/panama-foreign</a></p>
<div class="ulist">
<ul>
<li>
<p>同階層 <code>doc</code> ディレクトリには他にも参考になるドキュメントあり</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_呼び出し側を_java_で実装">呼び出し側を Java で実装</h3>
<div class="paragraph">
<p><code>jdk.incubator.foreign</code> 機能を用いてメモリ領域を確保し、自動生成した API <code>com.example.greeter_h.greeter()</code> を呼ぶコードを実装します。</p>
</div>
<div class="listingblock">
<div class="title">src/Main.java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import static com.example.greeter_h.*;
import static jdk.incubator.foreign.CLinker.*;

import jdk.incubator.foreign.*;
import java.awt.BorderLayout;
import java.io.Serial;
import java.nio.charset.StandardCharsets;
import javax.swing.*;

public class Main extends JFrame {

    @Serial
    private static final long serialVersionUID = 4648172894076113183L;

    public Main() {
        super(&#34;Rust GUI Frontend by Java Swing&#34;);
        setLayout(new BorderLayout());

        final JTextField nameField = new JTextField(20);

        final JTextField outputField = new JTextField(30);
        outputField.setEditable(false);

        final JButton greetButton = new JButton(&#34;greet&#34;);
        greetButton.addActionListener((e) -&gt; {
            try (ResourceScope scope = ResourceScope.newConfinedScope()) {
                final SegmentAllocator allocator = SegmentAllocator.ofScope(scope);
                final MemorySegment name = toCString(nameField.getText(), scope);
                final long size = 256;
                final MemorySegment message = allocator.allocateArray(C_CHAR, size);

                greet(name, message, size);

                // Project PanamaのJDKには存在するが、通常のJDK17には無い
                // final String retval = toJavaString(message, StandardCharsets.UTF_8);
                final String retval = toJavaString(message);
                outputField.setText(retval);
            }
        });

        add(nameField, BorderLayout.WEST);
        add(greetButton, BorderLayout.EAST);
        add(outputField, BorderLayout.SOUTH);
        pack();
    }

    public static void main(final String[] args) {
        SwingUtilities.invokeLater(() -&gt; {
            final Main app = new Main();
            app.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
            app.setVisible(true);
        });
    }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_補足">補足</h4>
<div class="ulist">
<ul>
<li>
<p>IDE を用いる場合、次のリンク先に IntelliJ の設定方法が説明されています。</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/carldea/panama4newbies/blob/main/README.md" class="bare">https://github.com/carldea/panama4newbies/blob/main/README.md</a></p>
<div class="ulist">
<ul>
<li>
<p>こちらのリンク、IDE の設定方法だけでなく、 Project Panama 全体の説明もわかりやすいと思います</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_java_コードビルド">Java コードビルド</h3>
<div class="paragraph">
<p>上記のコードを JDK17 でビルドするには <code>--add-modules jdk.incubator.foreign</code> オプションを付与する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">javac \
-encoding utf-8 \
-d ./classes \
-cp ./classes \
--add-modules jdk.incubator.foreign \
./src/Main.java</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_実行">実行</h3>
<div class="paragraph">
<p><code>--enable-native-access=ALL-UNNAMED</code>, <code>--add-modules jdk.incubator.foreign</code> オプションが必要です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">LD_LIBRARY_PATH=./greeter/target/release \
java \
-Dfile.encoding=utf-8 \
--enable-native-access=ALL-UNNAMED \
--add-modules jdk.incubator.foreign \
-cp ./classes Main</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_参考補足">参考/補足</h4>
<div class="ulist">
<ul>
<li>
<p>Windows で実行する場合、 <code>LD_LIBRARY_PATH</code> は機能しません。
代わりに、 <code>./greeter/target/release/greeter.dll</code> をカレントディレクトリにコピーしてから上のコマンドを実行します。</p>
</li>
<li>
<p><a href="https://github.com/openjdk/panama-foreign/blob/foreign-jextract/doc/panama_jextract.md#running-the-java-code-that-invokes-helloworld">Using the jextract tool &gt; Running the Java code that invokes helloworld</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>

        </section>
        <div class="post-tags">
          
          
          <nav class="nav tags">
            <ul class="tags">
              
              <li><a href="/tags/java">java</a></li>
              
              <li><a href="/tags/rust">rust</a></li>
              
            </ul>
          </nav>
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/yukihane" rel="me" title="GitHub"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github" />
</svg></a><a class="border"></a></div>
  <div class="footer-info">
    2025  &amp;copy;{year}, All Rights Reserved |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-E9J8FN5B4Q"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-E9J8FN5B4Q');
        }
      </script>

</div>
    </body>
</html>
