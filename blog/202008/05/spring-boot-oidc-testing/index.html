<!DOCTYPE html>
<html><head lang="ja">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Spring Security OAuth 2.0 Login を自動テストする - 発火後忘失</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
KeycloakをIdPにしてSpring Security OAuth 2.0 Login/Client を試してみる で作成したプログラムの自動テスト方法です。


今回のコードも前回と同じく次のディレクトリにあります:




https://github.com/yukihane/hello-java/tree/master/spring/oidc-example




まず結論なのですが、リファレンスに説明がありますのでここを参照しましょう、ということになります:
" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="https://yukihane.github.io/blog/202008/05/spring-boot-oidc-testing/">
  <meta property="og:site_name" content="発火後忘失">
  <meta property="og:title" content="Spring Security OAuth 2.0 Login を自動テストする">
  <meta property="og:description" content="KeycloakをIdPにしてSpring Security OAuth 2.0 Login/Client を試してみる で作成したプログラムの自動テスト方法です。
今回のコードも前回と同じく次のディレクトリにあります:
https://github.com/yukihane/hello-java/tree/master/spring/oidc-example
まず結論なのですが、リファレンスに説明がありますのでここを参照しましょう、ということになります:">
  <meta property="og:locale" content="ja">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2020-08-04T21:39:37+00:00">
    <meta property="article:modified_time" content="2020-08-04T21:39:37+00:00">
    <meta property="article:tag" content="Spring-Boot">
    <meta property="article:tag" content="Spring-Security">
    <meta property="article:tag" content="Oauth">
    <meta property="article:tag" content="Oidc">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Spring Security OAuth 2.0 Login を自動テストする">
  <meta name="twitter:description" content="KeycloakをIdPにしてSpring Security OAuth 2.0 Login/Client を試してみる で作成したプログラムの自動テスト方法です。
今回のコードも前回と同じく次のディレクトリにあります:
https://github.com/yukihane/hello-java/tree/master/spring/oidc-example
まず結論なのですが、リファレンスに説明がありますのでここを参照しましょう、ということになります:">

        <link href="https://yukihane.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://yukihane.github.io/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://yukihane.github.io/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css"  disabled />
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://yukihane.github.io/">発火後忘失</a>
	</div>
	<nav>
		
		<a href="/blog">Blog</a>
		
		<a href="/docs">Docs</a>
		
		<a href="/tags">Tags</a>
		
		<a href="https://github.com/yukihane/resume/blob/main/README.md">Resume</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#sun" />
</svg></span>
		<script src="https://yukihane.github.io/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">Spring Security OAuth 2.0 Login を自動テストする</h1>
          <div class="meta">Posted on 2020/08/04</div>
        </div>
        
        <section class="body">
          <div class="paragraph">
<p><a href="/blog/202007/21/hello-oidc-with-keycloak/">KeycloakをIdPにしてSpring Security OAuth 2.0 Login/Client を試してみる</a> で作成したプログラムの自動テスト方法です。</p>
</div>
<div class="paragraph">
<p>今回のコードも前回と同じく次のディレクトリにあります:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/yukihane/hello-java/tree/master/spring/oidc-example" class="bare">https://github.com/yukihane/hello-java/tree/master/spring/oidc-example</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>まず結論なのですが、リファレンスに説明がありますのでここを参照しましょう、ということになります:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/reference/html5/#testing-oauth2-client">Testing OAuth 2.0 Clients</a> - 19.2.2. SecurityMockMvcRequestPostProcessors</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>実際のコードがこちらです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@WebMvcTest
class HelloControllerTest {

    @Autowired
    ClientRegistrationRepository clientRegistrationRepository;

    /**
     * 未ログイン状態の場合、IdPへリダイレクトする。
     */
    @Test
    public void 未ログイン状態(@Autowired final MockMvc mvc) throws Exception {
        mvc.perform(get(&#34;/&#34;)).andExpect(status().is3xxRedirection())
            .andExpect(header().exists(&#34;Location&#34;));
    }

    @Test
    public void ログイン状態(@Autowired final MockMvc mvc) throws Exception {

        // https://docs.spring.io/spring-security/site/docs/current/reference/html5/#testing-oauth2-client
        mvc.perform(
            get(&#34;/&#34;)
                .with(oidcLogin()
                    .clientRegistration((this.clientRegistrationRepository.findByRegistrationId(&#34;myspring&#34;)))

                ))
            .andExpect(status().isOk());
    }

    @TestConfiguration
    static class AuthorizedClientConfig {
        @Bean
        OAuth2AuthorizedClientRepository authorizedClientRepository() {
            return new HttpSessionOAuth2AuthorizedClientRepository();
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>spring-security-oauth2</code> (何回も書きますが現在利用すべき Spring Security OAuth 2.0 Client とは別のライブラリです)時代は、 <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/reference/html5/#test-method-withmockuser"><code>@WithMockUser</code></a> や、 <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/reference/html5/#test-method-withsecuritycontext"><code>@WithSecurityContext</code></a> を利用してモック認証ユーザを作成していましたが、現在のライブラリではそのようにアノテーションで設定する方針は採らないようです。</p>
</div>
<div class="quoteblock">
<blockquote>
I think we avoided annotation support for OIDC because it was not very easy for users to customize the OidcUser and OAuth2AuthenticationToken objects (the attributes are rich objects which cannot easily be modified by an annotation). Instead, we felt that user’s could set SecurityContextHolder directly for method support or use the oidcLogin support for MockMvc style testing.
</blockquote>
<div class="attribution">
— , <a href="https://github.com/spring-projects/spring-security/pull/8461#issuecomment-624229723">spring-security-test @WithMockOidcuser gh-8459 #8461</a>
</div>
</div>
<hr/>
<div class="paragraph">
<p>続いて別の話なのですが、<a href="/blog/202007/21/hello-oidc-with-keycloak/">前回</a>、 <code>issuer-uri</code> だけ設定すれば他の設定が色々省略できて便利、と書きましたが、 <code>issuer-uri</code> を設定してしまうと(そして他の設定を省略すると) テスト開始時IdPへアクセスしに行こうとしてしまうようです。IdPに接続できないとテストが失敗します。</p>
</div>
<div class="paragraph">
<p>これを避けるために、結局、 <code>authorization-uri</code> などは明記する、というところで落ち着きました。</p>
</div>

        </section>
        <div class="post-tags">
          
          
          <nav class="nav tags">
            <ul class="tags">
              
              <li><a href="/tags/spring-boot">spring-boot</a></li>
              
              <li><a href="/tags/spring-security">spring-security</a></li>
              
              <li><a href="/tags/oauth">oauth</a></li>
              
              <li><a href="/tags/oidc">oidc</a></li>
              
            </ul>
          </nav>
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/yukihane" rel="me" title="GitHub"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github" />
</svg></a><a class="border"></a></div>
  <div class="footer-info">
    2025  &amp;copy;{year}, All Rights Reserved |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-E9J8FN5B4Q"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-E9J8FN5B4Q');
        }
      </script>

</div>
    </body>
</html>
